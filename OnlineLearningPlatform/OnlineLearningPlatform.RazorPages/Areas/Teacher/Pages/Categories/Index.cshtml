@page
@model OnlineLearningPlatform.RazorPages.Areas.Teacher.Pages.Categories.IndexModel
@{
    ViewData["Title"] = "Qu·∫£n l√Ω danh m·ª•c";
}

<style>
    .cat-page { animation: fadeUp .35s ease forwards; }

    .cat-header {
        display: flex; align-items: flex-start; justify-content: space-between;
        margin-bottom: var(--space-6); gap: var(--space-4); flex-wrap: wrap;
    }
    .cat-header-text h1 { font-size: var(--text-xl); font-weight: 700; letter-spacing: -.03em; color: var(--color-label-1); margin-bottom: var(--space-1); }
    .cat-header-text p  { font-size: var(--text-sm); color: var(--color-label-2); }

    .cat-badge {
        display: inline-flex; align-items: center; gap: 6px;
        padding: 4px 12px; border-radius: var(--radius-full);
        background: var(--color-blue-tint); color: var(--color-blue);
        font-size: var(--text-xs); font-weight: 600; margin-bottom: var(--space-2);
    }

    .tag-grid {
        display: flex; flex-wrap: wrap; gap: var(--space-3);
        padding: var(--space-8);
    }

    .tag-item {
        display: inline-flex; align-items: center; gap: var(--space-2);
        background: var(--color-surface-2);
        border: 1px solid var(--color-border-light);
        border-radius: var(--radius-full);
        padding: 8px 16px;
        font-size: var(--text-sm); color: var(--color-label-1); font-weight: 500;
        transition: background var(--transition), box-shadow var(--transition);
    }
    .tag-item:hover { background: var(--color-surface); box-shadow: var(--shadow-sm); }

    .tag-actions { display: flex; align-items: center; gap: var(--space-1); margin-left: var(--space-1); }
    .tag-btn {
        display: inline-flex; align-items: center; justify-content: center;
        width: 22px; height: 22px; border-radius: 50%;
        border: none; background: transparent; cursor: pointer;
        color: var(--color-label-3); font-size: 12px;
        transition: background var(--transition), color var(--transition);
        text-decoration: none; line-height: 1;
    }
    .tag-btn:hover { background: var(--color-border-light); opacity: 1; }
    .tag-btn-delete:hover { background: var(--color-red-tint); color: var(--color-red); }

    .empty-cats {
        padding: var(--space-16) var(--space-8); text-align: center;
        color: var(--color-label-2);
    }
    .empty-cats svg { margin: 0 auto var(--space-4); display: block; color: var(--color-label-3); }
    .empty-cats p { font-size: var(--text-sm); margin-bottom: var(--space-5); }
</style>

<div class="cat-page">
    <div class="page-head">
        <h1>Danh m·ª•c kh√≥a h·ªçc</h1>
        <div class="breadcrumb">
            <a asp-area="Teacher" asp-page="/Dashboard">Dashboard</a>
            <span class="breadcrumb-sep">‚Ä∫</span>
            <span>Danh m·ª•c</span>
        </div>
    </div>

    @if (TempData["SuccessMessage"] is string successMsg)
    {
        <div class="alert alert-success">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
            @successMsg
        </div>
    }
    @if (TempData["ErrorMessage"] is string errMsg)
    {
        <div class="alert alert-danger">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            @errMsg
        </div>
    }

    <div class="card">
        <div class="card-header">
            <div>
                <span class="cat-badge">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                    @Model.Categories.Count danh m·ª•c
                </span>
                <h2>T·∫•t c·∫£ danh m·ª•c</h2>
            </div>
            <a asp-area="Teacher" asp-page="/Categories/Create" class="btn btn-primary">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                T·∫°o danh m·ª•c
            </a>
        </div>

        @if (!Model.Categories.Any())
        {
            <div class="empty-cats" id="empty-cats-state">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/>
                </svg>
                <p>Ch∆∞a c√≥ danh m·ª•c n√†o.<br/>H√£y t·∫°o danh m·ª•c ƒë·∫ßu ti√™n ƒë·ªÉ ph√¢n lo·∫°i kh√≥a h·ªçc c·ªßa b·∫°n.</p>
                <a asp-area="Teacher" asp-page="/Categories/Create" class="btn btn-primary">T·∫°o danh m·ª•c ƒë·∫ßu ti√™n</a>
            </div>
        }
        else
        {
            <div class="tag-grid" id="cat-tag-grid">
                @foreach (var cat in Model.Categories)
                {
                    <div class="tag-item" id="cat-tag-@cat.CategoryId">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--color-blue);flex-shrink:0"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                        <span class="cat-name">@cat.CategoryName</span>
                        <div class="tag-actions">
                            <a asp-area="Teacher" asp-page="/Categories/Edit" asp-route-id="@cat.CategoryId"
                               class="tag-btn" title="Ch·ªânh s·ª≠a">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </a>
                            <a asp-area="Teacher" asp-page="/Categories/Delete" asp-route-id="@cat.CategoryId"
                               class="tag-btn tag-btn-delete" title="X√≥a">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
                            </a>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
<script src="~/lib/microsoft-signalr/signalr.min.js"></script>
<script>
(function () {
    // ==== SignalR: Teacher Category realtime ====
    const connection = new signalR.HubConnectionBuilder()
        .withUrl('/hubs/data')
        .withAutomaticReconnect()
        .build();

    // Helper: l·∫•y ho·∫∑c t·∫°o tag-grid
    function getOrCreateGrid() {
        let grid = document.getElementById('cat-tag-grid');
        if (!grid) {
            // ·∫®n empty state n·∫øu c√≥
            const empty = document.getElementById('empty-cats-state');
            if (empty) empty.style.display = 'none';
            // T·∫°o grid container
            const card = document.querySelector('.card');
            grid = document.createElement('div');
            grid.className = 'tag-grid';
            grid.id = 'cat-tag-grid';
            card.appendChild(grid);
        }
        return grid;
    }

    function buildTagItem(cat) {
        const div = document.createElement('div');
        div.className = 'tag-item';
        div.id = 'cat-tag-' + cat.categoryId;
        div.style.animation = 'fadeUp .3s ease forwards';
        div.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" style="color:var(--color-blue);flex-shrink:0">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                <line x1="7" y1="7" x2="7.01" y2="7"/>
            </svg>
            <span class="cat-name">${escHtml(cat.categoryName)}</span>
            <div class="tag-actions">
                <a href="/Teacher/Categories/Edit?id=${cat.categoryId}" class="tag-btn" title="Ch·ªânh s·ª≠a">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                </a>
                <a href="/Teacher/Categories/Delete?id=${cat.categoryId}" class="tag-btn tag-btn-delete" title="X√≥a">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6l-1 14H6L5 6"/>
                        <path d="M10 11v6"/><path d="M14 11v6"/>
                        <path d="M9 6V4h6v2"/>
                    </svg>
                </a>
            </div>`;
        return div;
    }

    function escHtml(str) {
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // ---- Event: Category m·ªõi ƒë∆∞·ª£c t·∫°o (b·ªüi b·∫•t k·ª≥ Teacher n√†o) ----
    connection.on('CategoryCreated', function (data) {
        // Tr√°nh th√™m tr√πng
        if (document.getElementById('cat-tag-' + data.categoryId)) return;
        const grid = getOrCreateGrid();
        grid.appendChild(buildTagItem(data));
        updateBadgeCount(1);
        showToast('‚úÖ Danh m·ª•c "' + escHtml(data.categoryName) + '" ƒë√£ ƒë∆∞·ª£c t·∫°o.', 'success');
    });

    // ---- Event: Category ƒë∆∞·ª£c c·∫≠p nh·∫≠t ----
    connection.on('CategoryUpdated', function (data) {
        const tag = document.getElementById('cat-tag-' + data.categoryId);
        if (!tag) return;
        const nameEl = tag.querySelector('.cat-name');
        if (nameEl) {
            nameEl.textContent = data.categoryName;
            tag.style.animation = 'none';
            tag.offsetHeight; // force reflow
            tag.style.animation = 'fadeUp .3s ease forwards';
        }
        showToast('‚úèÔ∏è Danh m·ª•c ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh "' + escHtml(data.categoryName) + '".', 'info');
    });

    // ---- Event: Category b·ªã x√≥a ----
    connection.on('CategoryDeleted', function (data) {
        const tag = document.getElementById('cat-tag-' + data.categoryId);
        if (!tag) return;
        tag.style.transition = 'opacity .3s ease, transform .3s ease';
        tag.style.opacity = '0';
        tag.style.transform = 'scale(0.8)';
        setTimeout(() => {
            tag.remove();
            updateBadgeCount(-1);
            // N·∫øu grid r·ªóng, hi·ªán l·∫°i empty state
            const grid = document.getElementById('cat-tag-grid');
            if (grid && grid.children.length === 0) {
                grid.remove();
                const empty = document.getElementById('empty-cats-state');
                if (empty) empty.style.display = '';
            }
        }, 300);
        showToast('üóëÔ∏è M·ªôt danh m·ª•c ƒë√£ b·ªã x√≥a.', 'warning');
    });

    function updateBadgeCount(delta) {
        const badge = document.querySelector('.cat-badge');
        if (!badge) return;
        const text = badge.textContent.trim();
        const match = text.match(/\d+/);
        if (match) {
            const newCount = Math.max(0, parseInt(match[0]) + delta);
            badge.textContent = newCount + ' danh m·ª•c';
        }
    }

    function showToast(msg, type) {
        const toast = document.createElement('div');
        toast.className = 'alert alert-' + (type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info');
        toast.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999;min-width:280px;animation:fadeUp .3s ease forwards;';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity .3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3500);
    }

    connection.start().catch(err => console.warn('[SignalR DataHub] Categories connect error:', err));
})();
</script>
}

