@page "{id:guid}"
@model OnlineLearningPlatform.RazorPages.Areas.Teacher.Pages.Courses.EditModel
@using OnlineLearningPlatform.Models.Entities
@{
    ViewData["Title"] = "Ch·ªânh s·ª≠a kh√≥a h·ªçc";
}

<style>
/* ‚îÄ‚îÄ 2-col edit layout ‚îÄ‚îÄ */
.edit-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: var(--space-6);
    align-items: start;
}
@@media(max-width: 860px) { .edit-layout { grid-template-columns: 1fr; } }

/* ‚îÄ‚îÄ Section cards within form ‚îÄ‚îÄ */
.edit-section {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-xl);
    overflow: hidden;
    margin-bottom: var(--space-4);
}
.edit-section-head {
    display: flex; align-items: center; gap: var(--space-3);
    padding: var(--space-5) var(--space-6);
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-surface-2);
}
.edit-section-icon {
    width: 36px; height: 36px; border-radius: var(--radius-sm); flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    background: var(--color-blue-tint);
}
.edit-section-icon svg { width: 18px; height: 18px; color: var(--color-blue); }
.edit-section-head h3 { font-size: var(--text-base); font-weight: 600; color: var(--color-label-1); }
.edit-section-head p  { font-size: var(--text-xs); color: var(--color-label-2); margin-top: 1px; }
.edit-section-body { padding: var(--space-6); }

/* ‚îÄ‚îÄ Field helpers ‚îÄ‚îÄ */
.field-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); }
@@media(max-width:600px){ .field-grid-2 { grid-template-columns: 1fr; } }
.field-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-4); }
@@media(max-width:600px){ .field-grid-3 { grid-template-columns: 1fr; } }
.field-group { margin-bottom: var(--space-5); }
.field-group:last-child { margin-bottom: 0; }
.field-label {
    display: block; font-size: var(--text-sm); font-weight: 500;
    color: var(--color-label-1); margin-bottom: var(--space-2);
}
.field-label .req { color: var(--color-red); }
.field-hint { display: block; font-size: var(--text-xs); color: var(--color-label-2); margin-top: 6px; }

/* ‚îÄ‚îÄ Sticky sidebar preview ‚îÄ‚îÄ */
.preview-sidebar { position: sticky; top: 72px; }
.preview-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-xl); overflow: hidden;
    margin-bottom: var(--space-4);
}
.preview-thumb {
    width: 100%; aspect-ratio: 16/9;
    background: linear-gradient(135deg, #e8f0fb, #f0eeff);
    display: flex; align-items: center; justify-content: center;
    font-size: 52px; overflow: hidden; position: relative;
}
.preview-thumb img { width: 100%; height: 100%; object-fit: cover; display: none; }
.preview-body { padding: var(--space-5); }
.preview-code {
    font-size: 10px; font-weight: 700; text-transform: uppercase;
    letter-spacing: .08em; color: var(--color-blue); margin-bottom: 4px;
}
.preview-title {
    font-size: var(--text-base); font-weight: 700; color: var(--color-label-1);
    letter-spacing: -.01em; line-height: 1.4; margin-bottom: var(--space-3);
    word-break: break-word; min-height: 1.4em;
}
.preview-tags { display: flex; flex-wrap: wrap; gap: var(--space-2); }
.preview-tag {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 11px; font-weight: 500;
    padding: 3px 9px; border-radius: var(--radius-full);
    background: var(--color-surface-2); color: var(--color-label-2);
    border: 1px solid var(--color-border-light);
}
.preview-price { font-size: var(--text-lg); font-weight: 700; color: var(--color-label-1); }
.preview-price.free { color: var(--color-green); }
.preview-price-disc { font-size: var(--text-sm); color: var(--color-label-3); text-decoration: line-through; margin-left: 6px; }

/* Sidebar actions */
.sidebar-actions { display: flex; flex-direction: column; gap: var(--space-2); }
.sidebar-actions .btn { justify-content: center; }

/* ‚îÄ‚îÄ Change dot ‚îÄ‚îÄ */
.unsaved-dot {
    width: 8px; height: 8px; border-radius: 50%; background: var(--color-amber);
    display: none; flex-shrink: 0; animation: pulse-dot 1.5s infinite;
}
.has-changes .unsaved-dot { display: inline-block; }
@@keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:.3} }

/* ‚îÄ‚îÄ Price section ‚îÄ‚îÄ */
.price-mode-row { display: flex; gap: var(--space-3); margin-bottom: var(--space-4); }
.price-mode-btn {
    flex: 1; padding: var(--space-3) var(--space-4); border-radius: var(--radius);
    border: 1.5px solid var(--color-border); background: var(--color-surface);
    cursor: pointer; text-align: center;
    font-size: var(--text-sm); font-weight: 500; color: var(--color-label-2);
    transition: all .18s ease; display: flex; align-items: center; justify-content: center; gap: 6px;
}
.price-mode-btn:hover { border-color: var(--color-blue); color: var(--color-blue); }
.price-mode-btn.active { border-color: var(--color-blue); background: var(--color-blue-tint); color: var(--color-blue); }
</style>

<div class="page-head fade-up">
    <h1 style="display:flex;align-items:center;gap:var(--space-3)">
        Ch·ªânh s·ª≠a kh√≥a h·ªçc
        <span class="unsaved-dot" id="unsavedDot" title="C√≥ thay ƒë·ªïi ch∆∞a l∆∞u"></span>
    </h1>
    <div class="breadcrumb">
        <a asp-area="Teacher" asp-page="/Dashboard">Dashboard</a>
        <span class="breadcrumb-sep">‚Ä∫</span>
        <a asp-area="Teacher" asp-page="/Courses/Index">Kh√≥a h·ªçc</a>
        <span class="breadcrumb-sep">‚Ä∫</span>
        <span>Ch·ªânh s·ª≠a</span>
    </div>
</div>

<div asp-validation-summary="All" class="alert alert-danger fade-up"></div>

<form method="post" id="editForm">
    <input asp-for="Input.CourseId" type="hidden" />

    <div class="edit-layout fade-up">

        <!-- ‚ïê‚ïê‚ïê LEFT: Edit fields ‚ïê‚ïê‚ïê -->
        <div>

            <!-- Section 1: Basic Info -->
            <div class="edit-section">
                <div class="edit-section-head">
                    <div class="edit-section-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>
                    </div>
                    <div>
                        <h3>Th√¥ng tin c∆° b·∫£n</h3>
                        <p>Ti√™u ƒë·ªÅ, m√£ v√† m√¥ t·∫£ kh√≥a h·ªçc</p>
                    </div>
                </div>
                <div class="edit-section-body">
                    <div class="field-group">
                        <label class="field-label" for="Input_Title">Ti√™u ƒë·ªÅ <span class="req">*</span></label>
                        <input asp-for="Input.Title" id="Input_Title" class="form-control"
                               placeholder="Ti√™u ƒë·ªÅ kh√≥a h·ªçc..." oninput="onFieldChange()" />
                        <span asp-validation-for="Input.Title" class="form-error"></span>
                    </div>

                    <div class="field-grid-2">
                        <div class="field-group" style="margin-bottom:0">
                            <label class="field-label" for="Input_CourseCode">M√£ kh√≥a h·ªçc <span class="req">*</span></label>
                            <input asp-for="Input.CourseCode" id="Input_CourseCode" class="form-control"
                                   placeholder="VD: REACT101" maxlength="20" oninput="onFieldChange()" />
                            <span class="field-hint">Vi·∫øt hoa, kh√¥ng d·∫•u, t·ªëi ƒëa 20 k√Ω t·ª±.</span>
                            <span asp-validation-for="Input.CourseCode" class="form-error"></span>
                        </div>
                        <div class="field-group" style="margin-bottom:0">
                            <label class="field-label" for="Input_Slug">Slug URL <span class="req">*</span></label>
                            <input asp-for="Input.Slug" id="Input_Slug" class="form-control"
                                   placeholder="VD: lap-trinh-react" maxlength="220" oninput="onFieldChange()" />
                            <span class="field-hint">Ch·ªâ d√πng a-z, 0-9, d·∫•u -.</span>
                            <span asp-validation-for="Input.Slug" class="form-error"></span>
                        </div>
                    </div>

                    <div class="field-group" style="margin-top:var(--space-5)">
                        <label class="field-label" for="Input_Description">M√¥ t·∫£</label>
                        <textarea asp-for="Input.Description" id="Input_Description" class="form-control"
                                  rows="5" placeholder="M√¥ t·∫£ n·ªôi dung, ƒë·ªëi t∆∞·ª£ng v√† l·ª£i √≠ch c·ªßa kh√≥a h·ªçc..."
                                  oninput="onFieldChange()"></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 2: Category & Level -->
            <div class="edit-section">
                <div class="edit-section-head">
                    <div class="edit-section-icon" style="background:#f0eeff">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#6b21a8" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                    </div>
                    <div>
                        <h3>Danh m·ª•c & Tr√¨nh ƒë·ªô</h3>
                        <p>Ph√¢n lo·∫°i v√† c·∫•p ƒë·ªô kh√≥a h·ªçc</p>
                    </div>
                </div>
                <div class="edit-section-body">
                    <div class="field-grid-3">
                        <div class="field-group" style="margin-bottom:0">
                            <label class="field-label" for="Input_CategoryId">Danh m·ª•c</label>
                            <select asp-for="Input.CategoryId" id="Input_CategoryId" class="form-control" onchange="onFieldChange()">
                                <option value="">-- Ch·ªçn --</option>
                                @foreach (var cat in Model.Categories)
                                {
                                    <option value="@cat.CategoryId">@cat.CategoryName</option>
                                }
                            </select>
                        </div>
                        <div class="field-group" style="margin-bottom:0">
                            <label class="field-label" for="Input_Level">Tr√¨nh ƒë·ªô</label>
                            <select asp-for="Input.Level" id="Input_Level" class="form-control"
                                    asp-items="Html.GetEnumSelectList<CourseLevel>()" onchange="onFieldChange()"></select>
                        </div>
                        <div class="field-group" style="margin-bottom:0">
                            <label class="field-label" for="Input_Language">Ng√¥n ng·ªØ</label>
                            <input asp-for="Input.Language" id="Input_Language" class="form-control"
                                   placeholder="vi" maxlength="10" oninput="onFieldChange()" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Pricing -->
            <div class="edit-section">
                <div class="edit-section-head">
                    <div class="edit-section-icon" style="background:var(--color-green-tint)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--color-green)" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <div>
                        <h3>H·ªçc ph√≠</h3>
                        <p>Gi√° g·ªëc v√† gi√° khuy·∫øn m√£i</p>
                    </div>
                </div>
                <div class="edit-section-body">
                    <div class="price-mode-row">
                        <button type="button" class="price-mode-btn @(Model.Input.Price == 0 ? "active" : "")" id="btnFree" onclick="setPriceMode('free')">
                            üéÅ Mi·ªÖn ph√≠
                        </button>
                        <button type="button" class="price-mode-btn @(Model.Input.Price > 0 ? "active" : "")" id="btnPaid" onclick="setPriceMode('paid')">
                            üí≥ C√≥ ph√≠
                        </button>
                    </div>

                    <div id="paidPriceFields" style="display:@(Model.Input.Price > 0 ? "block" : "none")">
                        <div class="field-grid-2">
                            <div class="field-group" style="margin-bottom:0">
                                <label class="field-label" for="Input_Price">Gi√° g·ªëc (VNƒê)</label>
                                <input asp-for="Input.Price" id="Input_Price" class="form-control"
                                       type="number" min="0" step="1000" oninput="onFieldChange()" />
                                <span asp-validation-for="Input.Price" class="form-error"></span>
                            </div>
                            <div class="field-group" style="margin-bottom:0">
                                <label class="field-label" for="Input_DiscountPrice">Gi√° khuy·∫øn m√£i (VNƒê)</label>
                                <input asp-for="Input.DiscountPrice" id="Input_DiscountPrice" class="form-control"
                                       type="number" min="0" step="1000" oninput="onFieldChange()" />
                                <span class="field-hint">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥ khuy·∫øn m√£i.</span>
                                <span asp-validation-for="Input.DiscountPrice" class="form-error"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Thumbnail -->
            <div class="edit-section">
                <div class="edit-section-head">
                    <div class="edit-section-icon" style="background:var(--color-amber-tint)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--color-amber)" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    </div>
                    <div>
                        <h3>·∫¢nh b√¨a</h3>
                        <p>URL ·∫£nh thumbnail hi·ªÉn th·ªã cho h·ªçc vi√™n</p>
                    </div>
                </div>
                <div class="edit-section-body">
                    <div class="field-group" style="margin-bottom:0">
                        <label class="field-label" for="Input_ThumbnailUrl">URL ·∫£nh b√¨a</label>
                        <input asp-for="Input.ThumbnailUrl" id="Input_ThumbnailUrl" class="form-control"
                               placeholder="https://..." oninput="onThumbChange(this.value); onFieldChange()" />
                        <span class="field-hint">Khuy·∫øn ngh·ªã t·ª∑ l·ªá 16:9 (1280√ó720px). ƒê·ªÉ tr·ªëng n·∫øu d√πng ·∫£nh m·∫∑c ƒë·ªãnh.</span>
                    </div>
                </div>
            </div>

            <!-- Submit bar -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:var(--space-3);padding-top:var(--space-2)">
                <a asp-area="Teacher" asp-page="/Courses/Details" asp-route-id="@Model.Input.CourseId" class="btn btn-secondary">
                    ‚Üê Qu·∫£n l√Ω n·ªôi dung
                </a>
                <div style="display:flex;gap:var(--space-3)">
                    <a asp-area="Teacher" asp-page="/Courses/Index" class="btn btn-secondary">H·ªßy</a>
                    <button type="submit" class="btn btn-primary" id="btnSave">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                        L∆∞u thay ƒë·ªïi
                    </button>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê RIGHT: Live preview ‚ïê‚ïê‚ïê -->
        <aside class="preview-sidebar">
            <div class="preview-card">
                <div class="preview-thumb" id="prevThumbWrap">
                    <img id="prevThumbImg" src="@Model.Input.ThumbnailUrl" alt="Preview"
                         style="@(!string.IsNullOrEmpty(Model.Input.ThumbnailUrl) ? "display:block" : "")" />
                    <span id="prevEmoji">üìö</span>
                </div>
                <div class="preview-body">
                    <div class="preview-code" id="prevCode">@Model.Input.CourseCode</div>
                    <div class="preview-title" id="prevTitle">@Model.Input.Title</div>
                    <div class="preview-tags" id="prevTags">
                        <span class="preview-tag" id="prevLevel">@Model.Input.Level</span>
                        <span class="preview-tag" id="prevLang">@Model.Input.Language.ToUpper()</span>
                    </div>
                    <div style="margin-top:var(--space-4)">
                        <span class="preview-price @(Model.Input.Price == 0 ? "free" : "")" id="prevPrice">
                            @(Model.Input.Price == 0 ? "Mi·ªÖn ph√≠" : Model.Input.Price.ToString("N0") + " ‚Ç´")
                        </span>
                        @if (Model.Input.DiscountPrice.HasValue && Model.Input.DiscountPrice > 0)
                        {
                            <span class="preview-price-disc" id="prevDisc">@Model.Input.Price.ToString("N0") ‚Ç´</span>
                        }
                        else
                        {
                            <span class="preview-price-disc" id="prevDisc" style="display:none"></span>
                        }
                    </div>
                </div>
            </div>

            <div class="preview-card">
                <div style="padding:var(--space-4) var(--space-5)">
                    <div style="font-size:var(--text-xs);font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--color-label-2);margin-bottom:var(--space-3)">Tr·∫°ng th√°i</div>
                    @{
                        var stClass = Model.Input.CourseId.HasValue ? "" : "";
                    }
                    <div style="font-size:var(--text-sm);color:var(--color-label-2)">
                        Sau khi l∆∞u, tr·∫°ng th√°i kh√≥a h·ªçc s·∫Ω gi·ªØ nguy√™n. Li√™n h·ªá admin ƒë·ªÉ xu·∫•t b·∫£n.
                    </div>
                </div>
            </div>

            <div class="sidebar-actions">
                <a asp-area="Teacher" asp-page="/Courses/Details" asp-route-id="@Model.Input.CourseId"
                   class="btn btn-secondary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                    Qu·∫£n l√Ω n·ªôi dung
                </a>
                <a asp-area="Teacher" asp-page="/Courses/Delete" asp-route-id="@Model.Input.CourseId"
                   class="btn btn-danger">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M9 6V4h6v2"/></svg>
                    X√≥a kh√≥a h·ªçc
                </a>
            </div>
        </aside>

    </div>
</form>

@section Scripts {
<partial name="_ValidationScriptsPartial" />
<script>
(function () {
    /* ‚îÄ‚îÄ Unsaved changes indicator ‚îÄ‚îÄ */
    let dirty = false;
    window.onFieldChange = function () {
        dirty = true;
        document.getElementById('editForm').classList.add('has-changes');
        updatePreview();
    };

    /* ‚îÄ‚îÄ Live preview update ‚îÄ‚îÄ */
    function updatePreview() {
        const title  = document.getElementById('Input_Title')?.value || '';
        const code   = document.getElementById('Input_CourseCode')?.value || '';
        const lvlSel = document.getElementById('Input_Level');
        const lvl    = lvlSel?.options[lvlSel.selectedIndex]?.text || '';
        const lang   = (document.getElementById('Input_Language')?.value || 'vi').toUpperCase();
        const price  = parseFloat(document.getElementById('Input_Price')?.value || '0') || 0;
        const disc   = parseFloat(document.getElementById('Input_DiscountPrice')?.value || '0') || 0;
        const isFree = document.getElementById('btnFree').classList.contains('active');

        document.getElementById('prevTitle').textContent = title || 'Ti√™u ƒë·ªÅ kh√≥a h·ªçc';
        document.getElementById('prevCode').textContent  = code  || 'CODE';
        document.getElementById('prevLevel').textContent = lvl;
        document.getElementById('prevLang').textContent  = lang;

        const priceEl = document.getElementById('prevPrice');
        const discEl  = document.getElementById('prevDisc');
        if (isFree || price === 0) {
            priceEl.textContent = 'Mi·ªÖn ph√≠';
            priceEl.className = 'preview-price free';
            discEl.style.display = 'none';
        } else {
            priceEl.textContent = price.toLocaleString('vi-VN') + ' ‚Ç´';
            priceEl.className = 'preview-price';
            if (disc > 0) {
                discEl.textContent = disc.toLocaleString('vi-VN') + ' ‚Ç´';
                discEl.style.display = '';
            } else {
                discEl.style.display = 'none';
            }
        }
    }

    /* ‚îÄ‚îÄ Thumbnail live preview ‚îÄ‚îÄ */
    window.onThumbChange = function (url) {
        const img   = document.getElementById('prevThumbImg');
        const emoji = document.getElementById('prevEmoji');
        if (url && url.startsWith('http')) {
            img.src = url;
            img.style.display = 'block';
            emoji.style.display = 'none';
        } else {
            img.src = '';
            img.style.display = 'none';
            emoji.style.display = '';
        }
    };

    // Init thumbnail preview
    const initUrl = document.getElementById('Input_ThumbnailUrl')?.value || '';
    if (initUrl) onThumbChange(initUrl);

    /* ‚îÄ‚îÄ Price mode ‚îÄ‚îÄ */
    window.setPriceMode = function (mode) {
        const btnFree = document.getElementById('btnFree');
        const btnPaid = document.getElementById('btnPaid');
        const fields  = document.getElementById('paidPriceFields');
        const priceIn = document.getElementById('Input_Price');

        if (mode === 'free') {
            btnFree.classList.add('active');
            btnPaid.classList.remove('active');
            fields.style.display = 'none';
            if (priceIn) { priceIn.value = '0'; }
        } else {
            btnPaid.classList.add('active');
            btnFree.classList.remove('active');
            fields.style.display = 'block';
        }
        onFieldChange();
    };

    /* ‚îÄ‚îÄ Warn before leaving with unsaved changes ‚îÄ‚îÄ */
    window.addEventListener('beforeunload', function (e) {
        if (dirty) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    document.getElementById('editForm').addEventListener('submit', function () {
        dirty = false; // Allow form submit
        const btn = document.getElementById('btnSave');
        btn.disabled = true;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/></svg> ƒêang l∆∞u...';
    });
})();
</script>
}
