@page "{id:guid}"
@model OnlineLearningPlatform.RazorPages.Areas.Teacher.Pages.Courses.DetailsModel
@{
    ViewData["Title"] = "Course Details";
}

@if (Model.Course is null)
{
    <div class="alert alert-warning">Course not found.</div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">@Model.Course.Title</h2>
            <p class="text-muted mb-0">Manage course sections and lessons.</p>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" asp-area="Teacher" asp-page="/Courses/Index">Back to List</a>
            <a class="btn btn-primary" asp-area="Teacher" asp-page="/Sections/Create" asp-route-courseId="@Model.Course.CourseId">Add Section</a>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6"><strong>Course Code:</strong> @Model.Course.CourseCode</div>
                <div class="col-md-6"><strong>Status:</strong> @Model.Course.Status</div>
                <div class="col-md-6"><strong>Category:</strong> @(Model.Course.Category?.CategoryName ?? "N/A")</div>
                <div class="col-md-6"><strong>Level:</strong> @Model.Course.Level</div>
                <div class="col-12"><strong>Description:</strong> @Model.Course.Description</div>
            </div>
        </div>
    </div>

    <h4 class="mb-3">Sections</h4>

    @if (Model.Sections.Count == 0)
    {
        <div class="alert alert-info">No sections yet. Click "Add Section" to create the first one.</div>
    }
    else
    {
        foreach (var sec in Model.Sections)
        {
            var lessons = Model.LessonsBySection.ContainsKey(sec.SectionId)
                ? Model.LessonsBySection[sec.SectionId]
                : new List<OnlineLearningPlatform.Models.Entities.Lesson>();

            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <div>
                        <strong>@sec.OrderIndex. @sec.Title</strong>
                    </div>
                    <div class="d-flex gap-2">
                        <a class="btn btn-sm btn-outline-secondary" asp-area="Teacher" asp-page="/Sections/Edit" asp-route-id="@sec.SectionId">Edit</a>
                        <a class="btn btn-sm btn-primary" asp-area="Teacher" asp-page="/Lessons/Create" asp-route-sectionId="@sec.SectionId">Add Lesson</a>
                        <form method="post" asp-page-handler="DeleteSection" asp-route-id="@Model.Course.CourseId" asp-route-sectionId="@sec.SectionId" onsubmit="return confirm('Bạn có chắc muốn xóa section này?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    @if (lessons.Count == 0)
                    {
                        <div class="text-muted">No lessons in this section yet.</div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">Order</th>
                                        <th>Lesson Title</th>
                                        <th style="width: 150px;">Type</th>
                                        <th style="width: 100px;">Preview</th>
                                        <th style="width: 120px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var lesson in lessons)
                                    {
                                        <tr>
                                            <td>@lesson.OrderIndex</td>
                                            <td>@lesson.Title</td>
                                            <td>@lesson.LessonType</td>
                                            <td>@(lesson.IsPreview ? "Yes" : "No")</td>
                                            <td>
                                                <form method="post" asp-page-handler="DeleteLesson" asp-route-id="@Model.Course.CourseId" asp-route-lessonId="@lesson.LessonId" onsubmit="return confirm('Bạn có chắc muốn xóa lesson này?');">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        }
    }
}