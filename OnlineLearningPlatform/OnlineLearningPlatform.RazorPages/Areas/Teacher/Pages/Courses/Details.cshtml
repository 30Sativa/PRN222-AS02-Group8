@page "{id:guid}"
@model OnlineLearningPlatform.RazorPages.Areas.Teacher.Pages.Courses.DetailsModel
@{
    ViewData["Title"] = "Course Details";
}

@if (Model.Course is null)
{
    <div class="alert alert-warning">Course not found.</div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">@Model.Course.Title</h2>
            <p class="text-muted mb-0">Manage course sections and lessons.</p>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" asp-area="Teacher" asp-page="/Courses/Index">Back to List</a>
            <a class="btn btn-primary" asp-area="Teacher" asp-page="/Sections/Create" asp-route-courseId="@Model.Course.CourseId">Add Section</a>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6"><strong>Course Code:</strong> @Model.Course.CourseCode</div>
                <div class="col-md-6"><strong>Status:</strong> @Model.Course.Status</div>
                <div class="col-md-6"><strong>Category:</strong> @(Model.Course.Category?.CategoryName ?? "N/A")</div>
                <div class="col-md-6"><strong>Level:</strong> @Model.Course.Level</div>
                <div class="col-12"><strong>Description:</strong> @Model.Course.Description</div>
            </div>
        </div>
    </div>

    <h4 class="mb-3">Sections</h4>

    @if (Model.Sections.Count == 0)
    {
        <div class="alert alert-info">No sections yet. Click "Add Section" to create the first one.</div>
    }
    else
    {
        <div class="accordion" id="sectionsAccordion">
            @for (var i = 0; i < Model.Sections.Count; i++)
            {
                var sec = Model.Sections[i];
                var lessons = Model.LessonsBySection.ContainsKey(sec.SectionId)
                    ? Model.LessonsBySection[sec.SectionId]
                    : new List<OnlineLearningPlatform.Models.Entities.Lesson>();

                var headingId = $"heading-{sec.SectionId}";
                var collapseId = $"collapse-{sec.SectionId}";
                var isFirst = i == 0;

                <div class="accordion-item border-0 shadow-sm mb-3 rounded overflow-hidden">
                    <h2 class="accordion-header" id="@headingId">
                        <button class="accordion-button @(isFirst ? string.Empty : "collapsed")"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#@collapseId"
                                aria-expanded="@(isFirst ? "true" : "false")"
                                aria-controls="@collapseId">
                            <strong>@sec.OrderIndex. @sec.Title</strong>
                        </button>
                    </h2>

                    <div id="@collapseId"
                         class="accordion-collapse collapse @(isFirst ? "show" : string.Empty)"
                         aria-labelledby="@headingId"
                         data-bs-parent="#sectionsAccordion">
                        <div class="accordion-body">
                            <div class="d-flex gap-2 mb-3">
                                <a class="btn btn-sm btn-outline-secondary" asp-area="Teacher" asp-page="/Sections/Edit" asp-route-id="@sec.SectionId">Edit Section</a>
                                <a class="btn btn-sm btn-primary" asp-area="Teacher" asp-page="/Lessons/Create" asp-route-sectionId="@sec.SectionId">Add Lesson</a>
                                <form method="post" asp-page-handler="DeleteSection" asp-route-id="@Model.Course.CourseId" asp-route-sectionId="@sec.SectionId" onsubmit="return confirm('Bạn có chắc muốn xóa section này?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete Section</button>
                                </form>
                            </div>

                            @if (lessons.Count == 0)
                            {
                                <div class="text-muted">No lessons in this section yet.</div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 80px;">Order</th>
                                                <th>Lesson Title</th>
                                                <th style="width: 150px;">Type</th>
                                                <th style="width: 100px;">Preview</th>
                                                <th style="width: 180px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var lesson in lessons)
                                            {
                                                <tr>
                                                    <td>@lesson.OrderIndex</td>
                                                    <td>
                                                        <a asp-page="/Lessons/Detail" asp-route-id="@lesson.LessonId" class="text-decoration-none fw-semibold">
                                                            @lesson.Title
                                                        </a>
                                                    </td>
                                                    <td>@lesson.LessonType</td>
                                                    <td>@(lesson.IsPreview ? "Yes" : "No")</td>
                                                    <td>
                                                        <div class="d-flex gap-2">
                                                            <a class="btn btn-sm btn-outline-secondary" asp-area="Teacher" asp-page="/Lessons/Edit" asp-route-id="@lesson.LessonId">Edit</a>
                                                            <form method="post" asp-page-handler="DeleteLesson" asp-route-id="@Model.Course.CourseId" asp-route-lessonId="@lesson.LessonId" onsubmit="return confirm('Bạn có chắc muốn xóa lesson này?');">
                                                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                                            </form>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
}
