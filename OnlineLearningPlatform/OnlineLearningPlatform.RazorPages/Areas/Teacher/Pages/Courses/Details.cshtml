@page "{id:guid}"
@model OnlineLearningPlatform.RazorPages.Areas.Teacher.Pages.Courses.DetailsModel
@using OnlineLearningPlatform.Models.Entities
@{
    ViewData["Title"] = Model.Course != null ? $"N·ªôi dung - {Model.Course.Title}" : "Chi ti·∫øt kh√≥a h·ªçc";
}

<style>
/* ‚îÄ‚îÄ Page layout ‚îÄ‚îÄ */
.course-detail-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: var(--space-6);
    align-items: start;
}
@@media(max-width:860px) { .course-detail-layout { grid-template-columns: 1fr; } }

/* ‚îÄ‚îÄ Course info sidebar ‚îÄ‚îÄ */
.course-info-card { position: sticky; top: 72px; }
.course-thumb {
    width: 100%; aspect-ratio: 16/9; border-radius: var(--radius-lg);
    object-fit: cover; background: var(--color-surface-2);
    display: flex; align-items: center; justify-content: center;
    font-size: 40px; color: var(--color-label-3);
    margin-bottom: var(--space-4); overflow: hidden;
}
.course-thumb img { width: 100%; height: 100%; object-fit: cover; }
.course-meta-row { display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2); font-size: var(--text-sm); }
.course-meta-row svg { width: 14px; height: 14px; color: var(--color-label-2); flex-shrink: 0; }
.course-status-badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 3px 10px; border-radius: var(--radius-full);
    font-size: var(--text-xs); font-weight: 600;
}
.badge-pending  { background: var(--color-amber-tint); color: var(--color-amber); }
.badge-published{ background: var(--color-green-tint);  color: var(--color-green); }
.badge-rejected { background: var(--color-red-tint);    color: var(--color-red); }

/* ‚îÄ‚îÄ Content area ‚îÄ‚îÄ */
.content-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: var(--space-5); gap: var(--space-3); flex-wrap: wrap;
}
.content-header h2 { font-size: var(--text-lg); font-weight: 700; letter-spacing: -.025em; }

/* ‚îÄ‚îÄ Empty content state ‚îÄ‚îÄ */
.empty-content {
    border: 2px dashed var(--color-border); border-radius: var(--radius-xl);
    padding: var(--space-12) var(--space-8); text-align: center;
}
.empty-content-icon { font-size: 48px; margin-bottom: var(--space-4); }
.empty-content h3 { font-size: var(--text-md); font-weight: 600; margin-bottom: var(--space-2); }
.empty-content p { font-size: var(--text-sm); color: var(--color-label-2); margin-bottom: var(--space-6); max-width: 400px; margin-left: auto; margin-right: auto; }

/* ‚îÄ‚îÄ Section accordion ‚îÄ‚îÄ */
.section-block {
    background: var(--color-surface); border: 1px solid var(--color-border-light);
    border-radius: var(--radius-xl); margin-bottom: var(--space-4); overflow: hidden;
    transition: box-shadow var(--transition);
}
.section-block:hover { box-shadow: var(--shadow-sm); }
.section-head {
    display: flex; align-items: center; gap: var(--space-3);
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-surface-2);
    cursor: pointer; user-select: none;
}
.section-head-chevron {
    transition: transform .2s ease;
    color: var(--color-label-2); flex-shrink: 0;
}
.section-block.collapsed .section-head-chevron { transform: rotate(-90deg); }
.section-idx {
    width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
    background: var(--color-blue-tint); color: var(--color-blue);
    font-size: 12px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
}
.section-head-title { font-size: var(--text-sm); font-weight: 600; color: var(--color-label-1); flex: 1; }
.section-head-meta { font-size: var(--text-xs); color: var(--color-label-2); }
.section-head-actions { display: flex; gap: var(--space-2); flex-shrink: 0; }

.section-body { padding: var(--space-4) var(--space-5); }
.section-body.hidden { display: none; }

/* ‚îÄ‚îÄ Lesson table ‚îÄ‚îÄ */
.lesson-list { list-style: none; margin-bottom: var(--space-3); }
.lesson-item {
    display: flex; align-items: center; gap: var(--space-3);
    padding: var(--space-3) 0;
    border-bottom: 1px solid var(--color-border-light);
}
.lesson-item:last-child { border-bottom: none; }
.lesson-type-dot {
    width: 30px; height: 30px; border-radius: var(--radius-sm); flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
}
.dot-video   { background: #e8f0fb; }
.dot-reading { background: var(--color-green-tint); }
.dot-quiz    { background: var(--color-amber-tint); }
.dot-video svg   { color: var(--color-blue); }
.dot-reading svg { color: var(--color-green); }
.dot-quiz svg    { color: var(--color-amber); }
.lesson-info { flex: 1; min-width: 0; }
.lesson-title { font-size: var(--text-sm); font-weight: 500; color: var(--color-label-1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.lesson-meta  { font-size: 11px; color: var(--color-label-2); margin-top: 1px; }
.preview-tag {
    font-size: 10px; font-weight: 600; padding: 2px 7px;
    border-radius: var(--radius-full);
    background: var(--color-blue-tint); color: var(--color-blue);
    margin-left: var(--space-2);
}
.lesson-actions { display: flex; gap: var(--space-1); flex-shrink: 0; }
.icon-btn {
    width: 30px; height: 30px; border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    border: 1px solid var(--color-border-light); background: var(--color-surface);
    cursor: pointer; color: var(--color-label-2);
    transition: background var(--transition), color var(--transition);
    text-decoration: none;
}
.icon-btn:hover { background: var(--color-surface-2); color: var(--color-label-1); opacity: 1; }
.icon-btn.danger:hover { background: var(--color-red-tint); border-color: var(--color-red); color: var(--color-red); }

.add-lesson-row {
    display: flex; align-items: center; gap: var(--space-2);
    padding: var(--space-3) 0 0;
}
</style>

@if (TempData["SuccessMessage"] is string ok)
{
    <div class="alert alert-success fade-up">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        @ok
    </div>
}
@if (TempData["ErrorMessage"] is string err)
{
    <div class="alert alert-danger fade-up">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        @err
    </div>
}

@if (Model.Course is null)
{
    <div class="alert alert-danger">Kh√¥ng t√¨m th·∫•y kh√≥a h·ªçc.</div>
    return;
}

<div class="page-head fade-up">
    <h1>@Model.Course.Title</h1>
    <div class="breadcrumb">
        <a asp-area="Teacher" asp-page="/Dashboard">Dashboard</a>
        <span class="breadcrumb-sep">‚Ä∫</span>
        <a asp-area="Teacher" asp-page="/Courses/Index">Kh√≥a h·ªçc</a>
        <span class="breadcrumb-sep">‚Ä∫</span>
        <span>N·ªôi dung kh√≥a h·ªçc</span>
    </div>
</div>

<div class="course-detail-layout fade-up">

    <!-- ‚îÄ‚îÄ LEFT: Content builder ‚îÄ‚îÄ -->
    <div>
        <div class="content-header">
            <div>
                <h2>Ch∆∞∆°ng tr√¨nh h·ªçc</h2>
                <p style="font-size:var(--text-sm);color:var(--color-label-2);margin-top:4px">
                    @Model.Sections.Count ph·∫ßn h·ªçc ¬∑
                    @(Model.LessonsBySection.Values.Sum(l => l.Count)) b√†i gi·∫£ng
                </p>
            </div>
            <a asp-area="Teacher" asp-page="/Sections/Create" asp-route-courseId="@Model.Course.CourseId"
               class="btn btn-primary">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Th√™m ph·∫ßn h·ªçc
            </a>
        </div>

        @if (!Model.Sections.Any())
        {
            <div class="empty-content">
                <div class="empty-content-icon">üìö</div>
                <h3>Kh√≥a h·ªçc ch∆∞a c√≥ n·ªôi dung</h3>
                <p>H√£y t·∫°o ph·∫ßn h·ªçc (Section) ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu x√¢y d·ª±ng ch∆∞∆°ng tr√¨nh gi·∫£ng d·∫°y cho h·ªçc vi√™n.</p>
                <a asp-area="Teacher" asp-page="/Sections/Create" asp-route-courseId="@Model.Course.CourseId"
                   class="btn btn-primary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    T·∫°o ph·∫ßn h·ªçc ƒë·∫ßu ti√™n
                </a>
            </div>
        }
        else
        {
            @for (var i = 0; i < Model.Sections.Count; i++)
            {
                var sec = Model.Sections[i];
                var lessons = Model.LessonsBySection.ContainsKey(sec.SectionId)
                    ? Model.LessonsBySection[sec.SectionId]
                    : new List<Lesson>();

                <div class="section-block" id="sec-@sec.SectionId">
                    <div class="section-head" onclick="toggleSection(@sec.SectionId)">
                        <svg class="section-head-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" id="chev-@sec.SectionId"><polyline points="6 9 12 15 18 9"/></svg>
                        <span class="section-idx">@(i + 1)</span>
                        <span class="section-head-title">@sec.Title</span>
                        <span class="section-head-meta">@lessons.Count b√†i</span>
                        <div class="section-head-actions" onclick="event.stopPropagation()">
                            <a asp-area="Teacher" asp-page="/Sections/Edit" asp-route-id="@sec.SectionId"
                               class="icon-btn" title="S·ª≠a ph·∫ßn h·ªçc">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </a>
                            <form method="post" asp-page-handler="DeleteSection"
                                  asp-route-id="@Model.Course.CourseId" asp-route-sectionId="@sec.SectionId"
                                  onsubmit="return confirm('X√≥a ph·∫ßn h·ªçc n√†y v√† to√†n b·ªô b√†i gi·∫£ng b√™n trong?')">
                                <button type="submit" class="icon-btn danger" title="X√≥a ph·∫ßn h·ªçc">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M9 6V4h6v2"/></svg>
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="section-body" id="body-@sec.SectionId">
                        @if (!lessons.Any())
                        {
                            <p style="font-size:var(--text-sm);color:var(--color-label-2);text-align:center;padding:var(--space-5) 0">
                                Ch∆∞a c√≥ b√†i gi·∫£ng n√†o.
                            </p>
                        }
                        else
                        {
                            <ul class="lesson-list">
                                @foreach (var lesson in lessons)
                                {
                                    var dotClass = lesson.LessonType.ToString() switch {
                                        "Video"   => "dot-video",
                                        "Reading" => "dot-reading",
                                        _         => "dot-quiz"
                                    };
                                    var typeIcon = lesson.LessonType.ToString() switch {
                                        "Video"   => "<polygon points='5 3 19 12 5 21 5 3'/>",
                                        "Reading" => "<path d='M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z'/><path d='M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z'/>",
                                        _         => "<circle cx='12' cy='12' r='10'/><line x1='12' y1='8' x2='12' y2='12'/><line x1='12' y1='16' x2='12.01' y2='16'/>"
                                    };
                                    <li class="lesson-item">
                                        <div class="lesson-type-dot @dotClass">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">@Html.Raw(typeIcon)</svg>
                                        </div>
                                        <div class="lesson-info">
                                            <div class="lesson-title">
                                                @lesson.OrderIndex. @lesson.Title
                                                @if (lesson.IsPreview)
                                                {
                                                    <span class="preview-tag">Demo</span>
                                                }
                                            </div>
                                            <div class="lesson-meta">@lesson.LessonType</div>
                                        </div>
                                        <div class="lesson-actions">
                                            <a asp-area="Teacher" asp-page="/Lessons/Edit" asp-route-id="@lesson.LessonId"
                                               class="icon-btn" title="S·ª≠a b√†i gi·∫£ng">
                                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                            </a>
                                            <form method="post" asp-page-handler="DeleteLesson"
                                                  asp-route-id="@Model.Course.CourseId" asp-route-lessonId="@lesson.LessonId"
                                                  onsubmit="return confirm('X√≥a b√†i gi·∫£ng n√†y?')">
                                                <button type="submit" class="icon-btn danger" title="X√≥a b√†i gi·∫£ng">
                                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M9 6V4h6v2"/></svg>
                                                </button>
                                            </form>
                                        </div>
                                    </li>
                                }
                            </ul>
                        }
                        <div class="add-lesson-row">
                            <a asp-area="Teacher" asp-page="/Lessons/Create" asp-route-sectionId="@sec.SectionId"
                               class="btn btn-secondary btn-sm">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Th√™m b√†i gi·∫£ng
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    <!-- ‚îÄ‚îÄ RIGHT: Course info sidebar ‚îÄ‚îÄ -->
    <aside class="course-info-card">
        <div class="card">
            <div class="card-body">
                <!-- Thumbnail -->
                <div class="course-thumb">
                    @if (!string.IsNullOrEmpty(Model.Course.ThumbnailUrl))
                    {
                        <img src="@Model.Course.ThumbnailUrl" alt="@Model.Course.Title" />
                    }
                    else
                    {
                        <span>üìö</span>
                    }
                </div>

                <!-- Status -->
                @{
                    var statusClass = Model.Course.Status switch {
                        CourseStatus.Published => "badge-published",
                        CourseStatus.Rejected  => "badge-rejected",
                        _                      => "badge-pending"
                    };
                    var statusLabel = Model.Course.Status switch {
                        CourseStatus.Published => "ƒê√£ xu·∫•t b·∫£n",
                        CourseStatus.Rejected  => "B·ªã t·ª´ ch·ªëi",
                        _                      => "Ch·ªù duy·ªát"
                    };
                }
                <div style="margin-bottom:var(--space-4)">
                    <span class="course-status-badge @statusClass">@statusLabel</span>
                </div>

                <!-- Meta rows -->
                <div class="course-meta-row">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>
                    <span style="color:var(--color-label-2)">M√£:</span>
                    <strong>@Model.Course.CourseCode</strong>
                </div>
                @if (Model.Course.Category != null)
                {
                    <div class="course-meta-row">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                        <span style="color:var(--color-label-2)">Danh m·ª•c:</span>
                        <strong>@Model.Course.Category.CategoryName</strong>
                    </div>
                }
                <div class="course-meta-row">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                    <span style="color:var(--color-label-2)">Tr√¨nh ƒë·ªô:</span>
                    <strong>@Model.Course.Level</strong>
                </div>
                <div class="course-meta-row">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    <span style="color:var(--color-label-2)">H·ªçc ph√≠:</span>
                    <strong>@(Model.Course.Price == 0 ? "Mi·ªÖn ph√≠" : Model.Course.Price.ToString("N0") + " ‚Ç´")</strong>
                </div>

                <div style="margin-top:var(--space-5);display:flex;flex-direction:column;gap:var(--space-2)">
                    <a asp-area="Teacher" asp-page="/Courses/Edit" asp-route-id="@Model.Course.CourseId"
                       class="btn btn-secondary" style="width:100%;justify-content:center">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        S·ª≠a th√¥ng tin kh√≥a h·ªçc
                    </a>
                    <a asp-area="Teacher" asp-page="/Courses/Index" class="btn btn-secondary" style="width:100%;justify-content:center">
                        ‚Üê Quay l·∫°i danh s√°ch
                    </a>
                </div>
            </div>
        </div>

        @if (Model.Course.Status == CourseStatus.Rejected && !string.IsNullOrEmpty(Model.Course.RejectionReason))
        {
            <div class="alert alert-danger" style="margin-top:var(--space-4)">
                <strong>L√Ω do t·ª´ ch·ªëi:</strong> @Model.Course.RejectionReason
            </div>
        }
    </aside>

</div>

@section Scripts {
<script>
function toggleSection(id) {
    const block = document.getElementById('sec-' + id);
    const body  = document.getElementById('body-' + id);
    const chev  = document.getElementById('chev-' + id);
    const collapsed = block.classList.toggle('collapsed');
    body.classList.toggle('hidden', collapsed);
}
</script>
}
