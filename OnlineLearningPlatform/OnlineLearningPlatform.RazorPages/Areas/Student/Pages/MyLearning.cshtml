@page
@model OnlineLearningPlatform.RazorPages.Areas.Student.Pages.MyLearningModel
@{
    ViewData["Title"] = "Kh√≥a h·ªçc c·ªßa t√¥i";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<style>
    .mylearning-header {
        margin-bottom: 32px;
    }

    .mylearning-header h1 {
        font-size: 28px;
        font-weight: 800;
        color: var(--color-label-1);
        margin: 0 0 4px;
    }

    .mylearning-header p {
        color: var(--color-label-2);
        font-size: 15px;
        margin: 0;
    }

    .courses-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
    }

    .course-card {
        background: var(--color-surface);
        border-radius: var(--radius);
        border: 1px solid var(--color-border-light);
        overflow: hidden;
        transition: box-shadow 0.2s, transform 0.2s;
    }

    .course-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .course-card-thumb {
        width: 100%;
        height: 180px;
        object-fit: cover;
        background: var(--color-surface-2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-label-3);
        font-size: 48px;
    }

    .course-card-body {
        padding: 20px;
    }

    .course-card-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--color-label-1);
        margin: 0 0 6px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .course-card-teacher {
        font-size: 13px;
        color: var(--color-label-2);
        margin-bottom: 16px;
    }

    /* Progress in card */
    .card-progress {
        margin-bottom: 16px;
    }

    .card-progress-bar {
        background: var(--color-surface-2);
        border-radius: var(--radius-full);
        height: 6px;
        overflow: hidden;
        margin-bottom: 6px;
    }

    .card-progress-fill {
        height: 100%;
        border-radius: var(--radius-full);
        transition: width 0.5s ease;
    }

    .card-progress-fill.in-progress {
        background: var(--color-blue);
    }

    .card-progress-fill.completed {
        background: var(--color-green);
    }

    .card-progress-text {
        font-size: 12px;
        color: var(--color-label-2);
        display: flex;
        justify-content: space-between;
    }

    .card-progress-text .percent {
        font-weight: 600;
        color: var(--color-blue);
    }

    .card-progress-text .percent.done {
        color: var(--color-green);
    }

    .course-card-footer {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-continue {
        flex: 1;
        text-align: center;
        padding: 10px 16px;
        border-radius: var(--radius-full);
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s;
    }

    .btn-continue.primary {
        background: var(--color-blue);
        color: #fff;
    }

    .btn-continue.primary:hover {
        background: var(--color-blue-hover);
    }

    .btn-continue.success {
        background: var(--color-green-tint);
        color: var(--color-green);
    }

    .last-accessed {
        font-size: 11px;
        color: var(--color-label-3);
        margin-top: 8px;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
    }

    .empty-state h2 {
        font-size: 22px;
        color: var(--color-label-1);
        margin-bottom: 8px;
    }

    .empty-state p {
        color: var(--color-label-2);
        margin-bottom: 24px;
    }

    .btn-browse {
        display: inline-block;
        padding: 12px 28px;
        background: var(--color-blue);
        color: #fff;
        border-radius: var(--radius-full);
        text-decoration: none;
        font-weight: 600;
        transition: background 0.2s;
    }

    .btn-browse:hover {
        background: var(--color-blue-hover);
    }
</style>

<div class="mylearning-header">
    <h1>Kh√≥a h·ªçc c·ªßa t√¥i</h1>
    <p>Ti·∫øp t·ª•c h·ªçc t·∫≠p v√† theo d√µi ti·∫øn ƒë·ªô c·ªßa b·∫°n</p>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success mt-3 mb-4 rounded-3 border-0" role="alert" style="background-color: rgba(52, 199, 89, 0.1); color: #34c759;">
        <i class="bi bi-check-circle-fill me-2"></i> @TempData["SuccessMessage"]
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger mt-3 mb-4 rounded-3 border-0" role="alert" style="background-color: rgba(255, 59, 48, 0.1); color: #ff3b30;">
        <i class="bi bi-x-circle-fill me-2"></i> @TempData["ErrorMessage"]
    </div>
}

@if (Model.EnrolledCourses.Any())
{
    <div class="courses-grid">
        @foreach (var item in Model.EnrolledCourses)
        {
            var course = item.Enrollment.Course;
            var progress = item.Progress;
            var isDone = progress.IsCompleted;

            <div class="course-card">
                @if (!string.IsNullOrEmpty(course.ThumbnailUrl))
                {
                    <img src="@course.ThumbnailUrl" alt="@course.Title" class="course-card-thumb" />
                }
                else
                {
                    <div class="course-card-thumb">üìö</div>
                }

                <div class="course-card-body">
                    <h3 class="course-card-title">@course.Title</h3>
                    <div class="course-card-teacher">@course.Teacher?.FullName</div>

                    <div class="card-progress">
                        <div class="card-progress-bar">
                            <div class="card-progress-fill @(isDone ? "completed" : "in-progress")"
                                 style="width: @progress.PercentComplete%"></div>
                        </div>
                        <div class="card-progress-text">
                            <span>@progress.CompletedLessons / @progress.TotalLessons b√†i</span>
                            <span class="percent @(isDone ? "done" : "")">@progress.PercentComplete%</span>
                        </div>
                    </div>

                    <div class="course-card-footer">
                        @if (isDone)
                        {
                            <a class="btn-continue success"
                               href="/Student/LearnCourse?courseId=@course.CourseId">
                                ‚úì ƒê√£ ho√†n th√†nh ‚Äî Xem l·∫°i
                            </a>
                        }
                        else
                        {
                            <a class="btn-continue primary"
                               href="/Student/LearnCourse?courseId=@course.CourseId@(item.ResumeLessonId.HasValue ? $"&lessonId={item.ResumeLessonId}" : "")">
                                ‚ñ∂ Ti·∫øp t·ª•c h·ªçc
                            </a>
                        }
                    </div>

                    @if (item.Enrollment.LastAccessedAt.HasValue)
                    {
                        <div class="last-accessed">
                            L·∫ßn truy c·∫≠p cu·ªëi: @item.Enrollment.LastAccessedAt.Value.ToString("dd/MM/yyyy HH:mm")
                        </div>
                    }

                    <div class="mt-3 text-end border-top pt-2">
                        <form method="post" asp-page-handler="Refund" asp-route-courseId="@course.CourseId"
                              onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën y√™u c·∫ßu ho√†n ti·ªÅn kh√≥a h·ªçc n√†y kh√¥ng? Quy·ªÅn truy c·∫≠p s·∫Ω b·ªã h·ªßy l·∫≠p t·ª©c!');">
                            <button type="submit" class="btn btn-sm text-danger" style="background: none; border: none; font-size: 0.85rem; padding: 0;">
                                <i class="bi bi-arrow-return-left"></i> Ho√†n ti·ªÅn v·ªÅ v√≠
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="empty-state">
        <h2>B·∫°n ch∆∞a ghi danh kh√≥a h·ªçc n√†o</h2>
        <p>Kh√°m ph√° c√°c kh√≥a h·ªçc v√† b·∫Øt ƒë·∫ßu h√†nh tr√¨nh h·ªçc t·∫≠p c·ªßa b·∫°n.</p>
        <a href="/Student/Dashboard" class="btn-browse">Kh√°m ph√° kh√≥a h·ªçc</a>
    </div>
}
