@page
@model OnlineLearningPlatform.RazorPages.Areas.Admin.Pages.Users.IndexModel
@{
    ViewData["Title"] = "Người dùng";
}

<div class="page-head fade-up">
    <h1>Người dùng</h1>
    <div class="breadcrumb">
        <a asp-area="Admin" asp-page="/Dashboard">Dashboard</a>
        <span class="breadcrumb-sep">/</span>
        <span>Danh sách</span>
    </div>
</div>

@if (Model.SuccessMessage != null)
{
    <div class="alert alert-success fade-up">@Model.SuccessMessage</div>
}
@if (Model.ErrorMessage != null)
{
    <div class="alert alert-danger fade-up">@Model.ErrorMessage</div>
}

<div class="card fade-up">

    <!-- Filter bar -->
    <form method="get" class="filter-bar">
        <div class="search-input-wrap">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" name="keyword" value="@Model.Keyword" placeholder="Tìm tên, email, số điện thoại..." />
        </div>

        <select name="role" class="filter-select" onchange="this.form.submit()">
            <option value="">Tất cả roles</option>
            <option value="Admin"   selected="@(Model.Role == "Admin")">Admin</option>
            <option value="Teacher" selected="@(Model.Role == "Teacher")">Giảng viên</option>
            <option value="Student" selected="@(Model.Role == "Student")">Học viên</option>
        </select>

        <button type="submit" class="btn btn-primary btn-sm">Tìm kiếm</button>

        @if (!string.IsNullOrWhiteSpace(Model.Keyword) || !string.IsNullOrWhiteSpace(Model.Role))
        {
            <a asp-page="/Users/Index" class="btn btn-secondary btn-sm">Xóa bộ lọc</a>
        }
    </form>

    <!-- Table -->
    <div class="card-header" style="border-top: 1px solid var(--color-border-light);">
        <h2>@Model.TotalCount kết quả</h2>
    </div>

    @if (Model.Users.Any())
    {
        <div class="table-wrap">
            <table class="table">
                <thead>
                    <tr>
                        <th>Người dùng</th>
                        <th>Số điện thoại</th>
                        <th>Role</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model.Users)
                    {
                        var avClass = user.Role switch { "Admin" => "u-avatar-admin", "Teacher" => "u-avatar-teacher", _ => "u-avatar-student" };
                        var roleClass = user.Role switch { "Admin" => "role-admin", "Teacher" => "role-teacher", _ => "role-student" };
                        var roleLabel = user.Role switch { "Teacher" => "Giảng viên", "Student" => "Học viên", _ => user.Role };

                        <tr>
                            <td>
                                <div class="user-cell">
                                    <div class="u-avatar @avClass">
                                        @(user.FullName?[0].ToString().ToUpper() ?? "U")
                                    </div>
                                    <div>
                                        <div class="u-name">@user.FullName</div>
                                        <div class="u-email">@user.Email</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-muted">@(user.PhoneNumber ?? "—")</td>
                            <td><span class="role-pill @roleClass">@roleLabel</span></td>
                            <td>
                                <div class="btn-group">
                                    <a asp-page="/Users/Detail" asp-area="Admin" asp-route-id="@user.Id"
                                       class="btn btn-secondary btn-sm">Xem</a>
                                    <a asp-page="/Users/Edit" asp-area="Admin" asp-route-id="@user.Id"
                                       class="btn btn-secondary btn-sm">Sửa</a>
                                    <form method="post" asp-page-handler="Delete" asp-route-id="@user.Id"
                                          onsubmit="return confirm('Xóa người dùng này?');">
                                        <button type="submit" class="btn btn-danger btn-sm">Xóa</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="pagination">
                @if (Model.PageNumber > 1)
                {
                    <a asp-page="/Users/Index" asp-area="Admin"
                       asp-route-keyword="@Model.Keyword" asp-route-role="@Model.Role"
                       asp-route-pageNumber="@(Model.PageNumber - 1)"
                       class="page-btn">←</a>
                }
                else
                {
                    <span class="page-btn disabled">←</span>
                }

                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    if (i == Model.PageNumber)
                    {
                        <span class="page-btn active">@i</span>
                    }
                    else
                    {
                        <a asp-page="/Users/Index" asp-area="Admin"
                           asp-route-keyword="@Model.Keyword" asp-route-role="@Model.Role"
                           asp-route-pageNumber="@i"
                           class="page-btn">@i</a>
                    }
                }

                @if (Model.PageNumber < Model.TotalPages)
                {
                    <a asp-page="/Users/Index" asp-area="Admin"
                       asp-route-keyword="@Model.Keyword" asp-route-role="@Model.Role"
                       asp-route-pageNumber="@(Model.PageNumber + 1)"
                       class="page-btn">→</a>
                }
                else
                {
                    <span class="page-btn disabled">→</span>
                }
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <h3>Không tìm thấy người dùng</h3>
            <p>Thử tìm kiếm với từ khóa hoặc bộ lọc khác.</p>
        </div>
    }
</div>
