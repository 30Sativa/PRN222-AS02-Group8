@page
@model OnlineLearningPlatform.RazorPages.Areas.Admin.Pages.Users.IndexModel
@{
    ViewData["Title"] = "Ng∆∞·ªùi d√πng";
}

<div class="page-head fade-up">
    <h1>Ng∆∞·ªùi d√πng</h1>
    <div class="breadcrumb">
        <a asp-area="Admin" asp-page="/Dashboard">Dashboard</a>
        <span class="breadcrumb-sep">/</span>
        <span>Danh s√°ch</span>
    </div>
</div>

@if (Model.SuccessMessage != null)
{
    <div class="alert alert-success fade-up">@Model.SuccessMessage</div>
}
@if (Model.ErrorMessage != null)
{
    <div class="alert alert-danger fade-up">@Model.ErrorMessage</div>
}

<div class="card fade-up">

    <!-- Filter bar -->
    <form method="get" class="filter-bar">
        <div class="search-input-wrap">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" name="keyword" value="@Model.Keyword" placeholder="T√¨m t√™n, email, s·ªë ƒëi·ªán tho·∫°i..." />
        </div>

        <select name="role" class="filter-select" onchange="this.form.submit()">
            <option value="">T·∫•t c·∫£ roles</option>
            <option value="Admin"   selected="@(Model.Role == "Admin")">Admin</option>
            <option value="Teacher" selected="@(Model.Role == "Teacher")">Gi·∫£ng vi√™n</option>
            <option value="Student" selected="@(Model.Role == "Student")">H·ªçc vi√™n</option>
        </select>

        <button type="submit" class="btn btn-primary btn-sm">T√¨m ki·∫øm</button>

        @if (!string.IsNullOrWhiteSpace(Model.Keyword) || !string.IsNullOrWhiteSpace(Model.Role))
        {
            <a asp-page="/Users/Index" class="btn btn-secondary btn-sm">X√≥a b·ªô l·ªçc</a>
        }
    </form>

    <!-- Table -->
    <div class="card-header" style="border-top: 1px solid var(--color-border-light);">
        <h2>@Model.TotalCount k·∫øt qu·∫£</h2>
    </div>

    @if (Model.Users.Any())
    {
        <div class="table-wrap">
            <table class="table">
                <thead>
                    <tr>
                        <th>Ng∆∞·ªùi d√πng</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>Role</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model.Users)
                    {
                        var avClass = user.Role switch { "Admin" => "u-avatar-admin", "Teacher" => "u-avatar-teacher", _ => "u-avatar-student" };
                        var roleClass = user.Role switch { "Admin" => "role-admin", "Teacher" => "role-teacher", _ => "role-student" };
                        var roleLabel = user.Role switch { "Teacher" => "Gi·∫£ng vi√™n", "Student" => "H·ªçc vi√™n", _ => user.Role };

                        <tr id="user-row-@user.Id">
                            <td>
                                <div class="user-cell">
                                    <div class="u-avatar @avClass">
                                        @(user.FullName?[0].ToString().ToUpper() ?? "U")
                                    </div>
                                    <div>
                                        <div class="u-name">@user.FullName</div>
                                        <div class="u-email">@user.Email</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-muted">@(user.PhoneNumber ?? "‚Äî")</td>
                            <td><span class="role-pill @roleClass">@roleLabel</span></td>
                            <td>
                                <div class="btn-group">
                                    <a asp-page="/Users/Detail" asp-area="Admin" asp-route-id="@user.Id"
                                       class="btn btn-secondary btn-sm">Xem</a>
                                    <a asp-page="/Users/Edit" asp-area="Admin" asp-route-id="@user.Id"
                                       class="btn btn-secondary btn-sm">S·ª≠a</a>
                                    <form method="post" asp-page-handler="Delete" asp-route-id="@user.Id"
                                          onsubmit="return confirm('X√≥a ng∆∞·ªùi d√πng n√†y?');">
                                        <button type="submit" class="btn btn-danger btn-sm">X√≥a</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @* Pagination *@

        @if (Model.TotalPages > 1)
        {
            <div class="pagination">
                @if (Model.PageNumber > 1)
                {
                    <a asp-page="/Users/Index" asp-area="Admin"
                       asp-route-keyword="@Model.Keyword" asp-route-role="@Model.Role"
                       asp-route-pageNumber="@(Model.PageNumber - 1)"
                       class="page-btn">‚Üê</a>
                }
                else
                {
                    <span class="page-btn disabled">‚Üê</span>
                }

                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    if (i == Model.PageNumber)
                    {
                        <span class="page-btn active">@i</span>
                    }
                    else
                    {
                        <a asp-page="/Users/Index" asp-area="Admin"
                           asp-route-keyword="@Model.Keyword" asp-route-role="@Model.Role"
                           asp-route-pageNumber="@i"
                           class="page-btn">@i</a>
                    }
                }

                @if (Model.PageNumber < Model.TotalPages)
                {
                    <a asp-page="/Users/Index" asp-area="Admin"
                       asp-route-keyword="@Model.Keyword" asp-route-role="@Model.Role"
                       asp-route-pageNumber="@(Model.PageNumber + 1)"
                       class="page-btn">‚Üí</a>
                }
                else
                {
                    <span class="page-btn disabled">‚Üí</span>
                }
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <h3>Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng</h3>
            <p>Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a ho·∫∑c b·ªô l·ªçc kh√°c.</p>
        </div>
    }
</div>

@section Scripts {
<script src="~/lib/microsoft-signalr/signalr.min.js"></script>
<script>
(function () {
    // ==== SignalR: Admin Users realtime ====
    const connection = new signalR.HubConnectionBuilder()
        .withUrl('/hubs/data')
        .withAutomaticReconnect()
        .build();

    function showToast(msg, type) {
        const toast = document.createElement('div');
        toast.className = 'alert alert-' + (type || 'info');
        toast.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999;min-width:280px;animation:fadeUp .3s ease forwards;';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.opacity='0'; toast.style.transition='opacity .3s ease'; setTimeout(()=>toast.remove(),300); }, 4000);
    }

    // Khi Admin x√≥a user (·ªü tab/c·ª≠a s·ªï kh√°c) ‚Üí x√≥a row tr√™n trang n√†y
    connection.on('UserDeleted', function (data) {
        const row = document.getElementById('user-row-' + data.userId);
        if (!row) return;
        row.style.transition = 'opacity .35s ease, transform .35s ease';
        row.style.opacity = '0';
        row.style.transform = 'translateX(20px)';
        setTimeout(() => {
            row.remove();
            // C·∫≠p nh·∫≠t count header
            const countEl = document.querySelector('.card-header h2');
            if (countEl) {
                const n = parseInt(countEl.textContent) - 1;
                countEl.textContent = Math.max(0, n) + ' k·∫øt qu·∫£';
            }
        }, 350);
        showToast('üóëÔ∏è Ng∆∞·ªùi d√πng ƒë√£ b·ªã x√≥a kh·ªèi h·ªá th·ªëng.', 'warning');
    });

    connection.start().catch(err => console.warn('[SignalR DataHub] Admin Users connect error:', err));
})();
</script>
}
