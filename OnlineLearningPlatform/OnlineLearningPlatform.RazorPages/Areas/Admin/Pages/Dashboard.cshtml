@page
@model OnlineLearningPlatform.RazorPages.Areas.Admin.Pages.DashboardModel
@using OnlineLearningPlatform.Services.DTOs.Dashboard
@{
    ViewData["Title"] = "Dashboard";

    // Helper function: chuyển DateTime → relative time string
    // NOTE: Khai báo trong @{ } để dùng được ở toàn trang
    string RelativeTime(DateTime dt)
    {
        var d = (DateTime.UtcNow - dt).Days;
        return d == 0 ? "Hôm nay"
             : d == 1 ? "Hôm qua"
             : d < 7  ? $"{d} ngày trước"
             : dt.ToString("dd/MM/yyyy");
    }
}

@* ────────────────────────────────────────────────────────────
   STYLES RIÊNG CHO DASHBOARD
   ──────────────────────────────────────────────────────────── *@
<style>
    .alert-banner {
        display: flex; align-items: center; gap: 12px;
        padding: 14px 20px;
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-6);
        font-size: var(--text-sm); font-weight: 500;
        animation: slideDown .35s cubic-bezier(.25,.46,.45,.94) both;
    }
    .alert-banner-warning {
        background: var(--color-amber-tint);
        border: 1px solid #f4c660; color: #7d5200;
    }
    .alert-banner svg { flex-shrink: 0; }
    .alert-banner strong { font-weight: 700; }

    /* Section label nhỏ trên mỗi nhóm stat */
    .stat-section-label {
        font-size: var(--text-xs); font-weight: 600;
        text-transform: uppercase; letter-spacing: .07em;
        color: var(--color-label-2);
        margin-bottom: var(--space-3); margin-top: var(--space-6);
    }
    .stat-section-label:first-of-type { margin-top: 0; }

    /* Icon trong stat card */
    .stat-card-icon {
        width: 36px; height: 36px; border-radius: var(--radius-sm);
        display: flex; align-items: center; justify-content: center;
        margin-bottom: var(--space-3);
    }
    .stat-card-icon svg { width: 18px; height: 18px; }

    .icon-blue   { background: var(--color-blue-tint);  color: var(--color-blue); }
    .icon-green  { background: var(--color-green-tint); color: var(--color-green); }
    .icon-red    { background: var(--color-red-tint);   color: var(--color-red); }
    .icon-amber  { background: var(--color-amber-tint); color: var(--color-amber); }
    .icon-purple { background: #f0eeff;                 color: #6b21a8; }
    .icon-gray   { background: var(--color-surface-2);  color: var(--color-label-2); }

    .stat-sub { font-size: 11px; color: var(--color-label-3); margin-top: 4px; }

    /* 2-column grid dưới stats */
    .dash-grid {
        display: grid; grid-template-columns: 1fr 1fr;
        gap: var(--space-5); margin-top: var(--space-5);
    }
    @@media (max-width: 768px) { .dash-grid { grid-template-columns: 1fr; } }

    .chart-container { position: relative; height: 220px; width: 100%; }

    /* Mini list */
    .mini-list { list-style: none; }
    .mini-list-item {
        display: flex; align-items: center; gap: var(--space-3);
        padding: var(--space-3) 0;
        border-bottom: 1px solid var(--color-border-light);
    }
    .mini-list-item:last-child { border-bottom: none; }
    .mini-list-icon {
        width: 36px; height: 36px; border-radius: var(--radius-sm);
        background: var(--color-surface-2);
        display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .mini-list-icon svg { width: 16px; height: 16px; color: var(--color-label-2); }
    .mini-list-body { flex: 1; min-width: 0; }
    .mini-list-title {
        font-size: var(--text-sm); font-weight: 500; color: var(--color-label-1);
        overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
    }
    .mini-list-meta { font-size: 11px; color: var(--color-label-2); margin-top: 2px; }

    /* Rank badge */
    .rank-badge {
        width: 24px; height: 24px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 11px; font-weight: 700; flex-shrink: 0;
    }
    .rank-1 { background: #ffd700; color: #7d5800; }
    .rank-2 { background: #c0c0c0; color: #555; }
    .rank-3 { background: #cd7f32; color: #5c3300; }
    .rank-n { background: var(--color-surface-2); color: var(--color-label-2); }

    .enroll-count { font-size: var(--text-xs); font-weight: 600; color: var(--color-blue); white-space: nowrap; }

    .empty-state {
        text-align: center; padding: var(--space-10) var(--space-6);
        color: var(--color-label-2); font-size: var(--text-sm);
    }

    @@keyframes slideDown {
        from { opacity: 0; transform: translateY(-8px); }
        to   { opacity: 1; transform: translateY(0); }
    }
</style>

@* ── PAGE HEADER ── *@
<div class="page-head fade-up">
    <h1>Dashboard</h1>
    <div class="breadcrumb">
        <span>Admin</span>
        <span class="breadcrumb-sep">›</span>
        <span>Tổng quan</span>
    </div>
</div>

@* ── ALERT BANNER: chỉ hiện khi có items cần xử lý ── *@
@if (Model.PendingCourses > 0 || Model.PendingRefunds > 0)
{
    <div class="alert-banner alert-banner-warning fade-up">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <span>
            Bạn có
            @if (Model.PendingCourses > 0)
            {
                <strong>@Model.PendingCourses khóa học</strong>
                @: chờ duyệt
            }
            @if (Model.PendingCourses > 0 && Model.PendingRefunds > 0)
            {
                @: và
            }
            @if (Model.PendingRefunds > 0)
            {
                <strong>@Model.PendingRefunds yêu cầu hoàn tiền</strong>
                @: cần xử lý
            }
            — hãy xử lý sớm để tránh ảnh hưởng trải nghiệm người dùng.
        </span>
    </div>
}

@* ── STATS 1: NGƯỜI DÙNG ── *@
<p class="stat-section-label fade-up">Người dùng</p>
<div class="stat-grid fade-up">

    <div class="stat-card">
        <div class="stat-card-icon icon-blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
        </div>
        <div class="stat-label">Tổng người dùng</div>
        <div class="stat-value">@Model.TotalUsers</div>
    </div>

    <div class="stat-card">
        <div class="stat-card-icon icon-green">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                <path d="M6 12v5c3 3 9 3 12 0v-5"/>
            </svg>
        </div>
        <div class="stat-label">Học viên</div>
        <div class="stat-value">@Model.TotalStudents</div>
    </div>

    <div class="stat-card">
        <div class="stat-card-icon icon-blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="8" r="4"/>
                <path d="M20 21a8 8 0 1 0-16 0"/>
                <path d="M15 3h6M18 3v6"/>
            </svg>
        </div>
        <div class="stat-label">Giảng viên</div>
        <div class="stat-value">@Model.TotalTeachers</div>
    </div>

    <div class="stat-card">
        <div class="stat-card-icon icon-gray">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
        </div>
        <div class="stat-label">Quản trị</div>
        <div class="stat-value">@Model.TotalAdmins</div>
    </div>

</div>

@* ── STATS 2: KHÓA HỌC & ĐĂNG KÝ ── *@
<p class="stat-section-label fade-up">Khóa học &amp; Đăng ký</p>
<div class="stat-grid fade-up">

    <div class="stat-card">
        <div class="stat-card-icon icon-blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                <line x1="8" y1="21" x2="16" y2="21"/>
                <line x1="12" y1="17" x2="12" y2="21"/>
            </svg>
        </div>
        <div class="stat-label">Tổng khóa học</div>
        <div class="stat-value">@Model.TotalCourses</div>
        <div class="stat-sub">@Model.PublishedCourses đã xuất bản</div>
    </div>

    <div class="stat-card">
        <div class="stat-card-icon icon-amber">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        </div>
        <div class="stat-label">Chờ duyệt</div>
        <div class="stat-value">@Model.PendingCourses</div>
        <div class="stat-sub">Khóa học cần review</div>
    </div>

    <div class="stat-card">
        <div class="stat-card-icon icon-green">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <polyline points="16 11 18 13 22 9"/>
            </svg>
        </div>
        <div class="stat-label">Tổng đăng ký</div>
        <div class="stat-value">@Model.TotalEnrollments</div>
        <div class="stat-sub">+@Model.NewEnrollmentsThisMonth trong 30 ngày qua</div>
    </div>

    <div class="stat-card">
        <div class="stat-card-icon icon-red">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="1 4 1 10 7 10"/>
                <path d="M3.51 15a9 9 0 1 0 .49-3.51"/>
            </svg>
        </div>
        <div class="stat-label">Hoàn tiền chờ duyệt</div>
        <div class="stat-value">@Model.PendingRefunds</div>
        <div class="stat-sub">Yêu cầu cần xử lý</div>
    </div>

</div>

@* ── STATS 3: DOANH THU ── *@
<p class="stat-section-label fade-up">Doanh thu</p>
<div class="stat-grid fade-up" style="grid-template-columns: 1fr 1fr; max-width: 560px;">

    <div class="stat-card">
        <div class="stat-card-icon icon-purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
        </div>
        <div class="stat-label">Tổng doanh thu</div>
        <div class="stat-value" style="font-size:24px;">
            @Model.TotalRevenue.ToString("N0")
            <span style="font-size:14px;font-weight:400;color:var(--color-label-2)">đ</span>
        </div>
        <div class="stat-sub">Từ các đơn đã hoàn thành</div>
    </div>

    <div class="stat-card">
        <div class="stat-card-icon icon-purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                <polyline points="17 6 23 6 23 12"/>
            </svg>
        </div>
        <div class="stat-label">30 ngày gần đây</div>
        <div class="stat-value" style="font-size:24px;">
            @Model.RevenueThisMonth.ToString("N0")
            <span style="font-size:14px;font-weight:400;color:var(--color-label-2)">đ</span>
        </div>
        <div class="stat-sub">Doanh thu tháng này</div>
    </div>

</div>

@* ── ROW 1: Chart + Top Courses ── *@
<div class="dash-grid fade-up">

    @* Chart doanh thu *@
    <div class="card">
        <div class="card-header">
            <h2>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;margin-right:6px;vertical-align:-2px;color:var(--color-blue)">
                    <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Doanh thu theo tháng
            </h2>
            <span style="font-size:11px;color:var(--color-label-2);font-weight:400">Năm @DateTime.Now.Year</span>
        </div>
        <div class="card-body" style="padding:var(--space-5) var(--space-6);">
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    @* Top khóa học *@
    <div class="card">
        <div class="card-header">
            <h2>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;margin-right:6px;vertical-align:-2px;color:var(--color-blue)">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                Top khóa học
            </h2>
            <span style="font-size:11px;color:var(--color-label-2);font-weight:400">Theo lượt đăng ký</span>
        </div>
        <div class="card-body" style="padding:0 var(--space-6) var(--space-4);">
            @if (!Model.Stats.TopCourses.Any())
            {
                <div class="empty-state">Chưa có dữ liệu</div>
            }
            else
            {
                <ul class="mini-list">
                    @{
                        // Dùng biến đếm rank ngoài foreach để tránh lỗi Razor
                        int rankIdx = 0;
                    }
                    @foreach (var item in Model.Stats.TopCourses)
                    {
                        rankIdx++;
                        // Xác định CSS class cho rank badge (vàng / bạc / đồng / bình thường)
                        string rankClass = rankIdx == 1 ? "rank-1"
                                         : rankIdx == 2 ? "rank-2"
                                         : rankIdx == 3 ? "rank-3"
                                         : "rank-n";
                        <li class="mini-list-item">
                            <span class="rank-badge @rankClass">@rankIdx</span>
                            <div class="mini-list-body">
                                <div class="mini-list-title" title="@item.Course.Title">@item.Course.Title</div>
                                <div class="mini-list-meta">
                                    @item.Course.TeacherName
                                    @if (!string.IsNullOrEmpty(item.Course.CategoryName))
                                    {
                                        <span> · @item.Course.CategoryName</span>
                                    }
                                </div>
                            </div>
                            <span class="enroll-count">@item.EnrollmentCount HV</span>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>

</div>

@* ── ROW 2: Pending Courses + Quick Access ── *@
<div class="dash-grid fade-up">

    @* Khóa học chờ duyệt *@
    <div class="card">
        <div class="card-header">
            <h2>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;margin-right:6px;vertical-align:-2px;color:var(--color-amber)">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                Khóa học chờ duyệt
            </h2>
            <a asp-area="Admin" asp-page="/Courses/Index" class="btn btn-sm btn-secondary">Xem tất cả</a>
        </div>
        <div class="card-body" style="padding:0 var(--space-6) var(--space-4);">
            @if (!Model.Stats.RecentPendingCourses.Any())
            {
                <div class="empty-state">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin:0 auto var(--space-3)">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    <p>Không có khóa học nào chờ duyệt</p>
                </div>
            }
            else
            {
                <ul class="mini-list">
                    @foreach (var course in Model.Stats.RecentPendingCourses)
                    {
                        <li class="mini-list-item">
                            <div class="mini-list-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                    <line x1="8" y1="21" x2="16" y2="21"/>
                                    <line x1="12" y1="17" x2="12" y2="21"/>
                                </svg>
                            </div>
                            <div class="mini-list-body">
                                <div class="mini-list-title" title="@course.Title">@course.Title</div>
                                <div class="mini-list-meta">
                                    <span>@course.TeacherName</span>
                                    @* Dùng helper RelativeTime() định nghĩa ở đầu trang thay vì if/else lồng nhau *@
                                    <span style="margin-left:8px;">@RelativeTime(course.CreatedAt)</span>
                                </div>
                            </div>
                            <a asp-area="Admin" asp-page="/Courses/Details" asp-route-id="@course.CourseId"
                               class="btn btn-sm btn-secondary" style="flex-shrink:0">Review</a>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>

    @* Quick Access *@
    <div class="card">
        <div class="card-header">
            <h2>Truy cập nhanh</h2>
        </div>
        <div class="card-body">
            <div class="quick-grid" style="grid-template-columns:1fr 1fr;gap:var(--space-3);">

                <a asp-area="Admin" asp-page="/Users/Index" class="quick-item">
                    <div class="quick-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div class="quick-item-title">Người dùng</div>
                    <div class="quick-item-desc">Xem, chỉnh sửa, đổi role</div>
                </a>

                <a asp-area="Admin" asp-page="/Courses/Index" class="quick-item">
                    <div class="quick-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                            <line x1="8" y1="21" x2="16" y2="21"/>
                            <line x1="12" y1="17" x2="12" y2="21"/>
                        </svg>
                    </div>
                    <div class="quick-item-title">Khóa học</div>
                    <div class="quick-item-desc">Duyệt và quản lý nội dung</div>
                </a>

                <a asp-area="Admin" asp-page="/Categories/Index" class="quick-item">
                    <div class="quick-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
                            <line x1="4" y1="22" x2="4" y2="15"/>
                        </svg>
                    </div>
                    <div class="quick-item-title">Danh mục</div>
                    <div class="quick-item-desc">Quản lý phân loại khóa học</div>
                </a>

                <div class="quick-item quick-item-disabled">
                    <span class="badge-soon">Sắp có</span>
                    <div class="quick-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                    </div>
                    <div class="quick-item-title">Báo cáo</div>
                    <div class="quick-item-desc">Doanh thu &amp; hoạt động hệ thống</div>
                </div>

            </div>
        </div>
    </div>

</div>

@* ── CHART.JS ── *@
@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    (function () {
        // Dữ liệu 12 tháng được server truyền xuống dưới dạng JSON array
        // Ví dụ: [0, 500000, 1200000, 800000, ...]
        const monthlyData = @Html.Raw(Model.MonthlyRevenueJson);
        const labels = ['T1','T2','T3','T4','T5','T6','T7','T8','T9','T10','T11','T12'];

        const ctx = document.getElementById('revenueChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 220);
        gradient.addColorStop(0, 'rgba(0,113,227,0.25)');
        gradient.addColorStop(1, 'rgba(0,113,227,0)');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu (đ)',
                    data: monthlyData,
                    fill: true,
                    backgroundColor: gradient,
                    borderColor: '#0071e3',
                    borderWidth: 2,
                    pointBackgroundColor: '#0071e3',
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                return ctx.parsed.y.toLocaleString('vi-VN') + ' đ';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        border: { display: false },
                        ticks: { font: { size: 11 }, color: '#6e6e73' }
                    },
                    y: {
                        grid: { color: 'rgba(0,0,0,.04)' },
                        border: { display: false },
                        ticks: {
                            font: { size: 11 }, color: '#6e6e73',
                            callback: function(val) {
                                if (val >= 1000000) return (val / 1000000).toFixed(1) + 'tr';
                                if (val >= 1000) return (val / 1000).toFixed(0) + 'K';
                                return val;
                            }
                        }
                    }
                }
            }
        });
    })();
</script>
}
